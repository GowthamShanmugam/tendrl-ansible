---

- name: Install tendrl-node-agent
  yum:
    name=tendrl-node-agent
    state=latest

- name: Configure etcd and graphite ip addr in node-agent.conf.yaml
  lineinfile:
    dest: /etc/tendrl/node-agent/node-agent.conf.yaml
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  with_items:
    - regexp: '^etcd_connection:.*'
      line: "etcd_connection: {{ etcd_ip_address }}"
    - regexp: '^graphite_host:.*'
      line: "graphite_host: {{ graphite_ip_address }}"
  notify:
    - restart tendrl-node-agent

- name: Detection if etcd_root_passwd (ansible password lookup file) exists
  local_action: stat path=etcd_root_passwd
  register: stat_etcd_root_passwd
  run_once: True
  when: etcd_authentication == True

- name: Make sure that etcd_root_passwd (ansible password lookup file) exists
  fail:
    msg:
      - "to configure etcd credentials in tendrl config files, etcd_root_passwd (ansible password lookup) file is required"
      - "since etcd_root_passwd is missing, we can't continue"
      - "under normal conditions, etcd_root_passwd is created by ansible when tendrl-server role is executed"
  when: etcd_authentication == True and stat_etcd_root_passwd['stat']['exists'] == False
  run_once: True
  delegate_to: localhost

- name: Configure etcd username and password in node-agent.conf.yaml
  lineinfile:
    dest: /etc/tendrl/node-agent/node-agent.conf.yaml
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  with_items:
    - regexp: '^#? *etcd_username:.*'
      line: "etcd_username: root"
    - regexp: '^#? *etcd_password:.*'
      line: "etcd_password: {{ lookup('password', 'etcd_root_passwd') }}"
  notify:
    - restart tendrl-node-agent
  when: etcd_authentication == True

- name: Enable tendrl-node-agent service
  service:
    name=tendrl-node-agent
    enabled=yes

- name: Start tendrl-node-agent service
  service:
    name=tendrl-node-agent
    state=started
